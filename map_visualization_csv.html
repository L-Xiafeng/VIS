<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>苏州园林地理分布可视化</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
        }

        #container {
            width: 100%;
            height: 100vh;
            position: relative;
        }

        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
            max-width: 350px;
            z-index: 1000;
        }

        .info-panel h1 {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #1890ff;
            padding-bottom: 10px;
        }

        .info-panel .stats {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .info-panel .legend {
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 13px;
            color: #555;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .legend-item:hover {
            background: rgba(24, 144, 255, 0.1);
        }

        .legend-item.active {
            background: rgba(24, 144, 255, 0.2);
            border: 1px solid #1890ff;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #1890ff;
            z-index: 999;
            background: white;
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
        }

        .detail-popup {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            max-width: 300px;
        }

        .detail-popup h3 {
            color: #1890ff;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .detail-popup p {
            margin: 6px 0;
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .detail-popup .label {
            font-weight: bold;
            color: #333;
        }

        .district-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.98);
            padding: 12px 15px;
            border-radius: 6px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 380px;
            min-width: 280px;
            z-index: 9999;
            max-height: 85vh;
            overflow-y: auto;
            border: 2px solid #1890ff;
        }

        .district-panel h2 {
            font-size: 15px;
            color: #333;
            margin-bottom: 10px;
            border-bottom: 2px solid #52c41a;
            padding-bottom: 6px;
        }

        .district-stats {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }

        .district-stats .stat-item {
            margin: 5px 0;
            padding: 4px 8px;
            background: #f5f5f5;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .district-stats .stat-label {
            font-weight: 500;
            color: #333;
            font-size: 13px;
        }

        .district-stats .stat-value {
            font-weight: bold;
            color: #1890ff;
            font-size: 16px;
        }

        .district-stats .stat-value.world {
            color: #DC2626;
            font-weight: 900;
        }

        .district-stats .stat-value.national {
            color: #EA580C;
        }

        .district-stats .stat-value.provincial {
            color: #F59E0B;
        }

        .district-stats .stat-value.city {
            color: #EAB308;
        }

        .district-hint {
            margin-top: 15px;
            padding: 10px;
            background: #e6f7ff;
            border-left: 3px solid #1890ff;
            font-size: 12px;
            color: #666;
            border-radius: 4px;
        }

    </style>
</head>

<body>
    <div id="container"></div>
    <div class="info-panel">
        <h1>苏州园林地理分布</h1>
        <div class="stats">
            <p>总计园林数量: <strong id="total-count">0</strong></p>
        </div>
        <div class="legend">
            <div class="legend-item" data-level="world">
                <div class="legend-color" style="background: #DC2626;"></div>
                <span>世界遗产园林</span>
            </div>
            <div class="legend-item" data-level="national">
                <div class="legend-color" style="background: #EA580C;"></div>
                <span>全国重点文物保护单位</span>
            </div>
            <div class="legend-item" data-level="provincial">
                <div class="legend-color" style="background: #F59E0B;"></div>
                <span>省级文物保护单位</span>
            </div>
            <div class="legend-item" data-level="city">
                <div class="legend-color" style="background: #EAB308;"></div>
                <span>市级文物保护单位</span>
            </div>
            <div class="legend-item" data-level="other">
                <div class="legend-color" style="background: #D1D5DB;"></div>
                <span>其他园林</span>
            </div>
        </div>
    </div>
    <div class="district-panel" id="districtPanel" style="display: none;">
        <h2 id="districtName">选择区县查看统计</h2>
        <div class="district-stats" id="districtStats">
            <div class="stat-item">
                <span class="stat-label">世界文化遗产:</span>
                <span class="stat-value world" id="worldCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">全国重点文保:</span>
                <span class="stat-value national" id="nationalCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">省级文保:</span>
                <span class="stat-value provincial" id="provincialCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">市级文保:</span>
                <span class="stat-value city" id="cityCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">其他园林:</span>
                <span class="stat-value" id="otherCount">0</span>
            </div>
            <div class="stat-item" style="background: #fff7e6; border: 1px solid #ffd591;">
                <span class="stat-label" style="color: #d46b08;">总计:</span>
                <span class="stat-value" style="color: #d46b08; font-size: 15px;" id="totalDistrictCount">0</span>
            </div>
        </div>

        <!-- 雷达图容器 -->
        <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #e8e8e8;">
            <h3 style="font-size: 11px; color: #666; margin-bottom: 4px; text-align: center;">区县综合指标</h3>
            <div id="radarChart" style="width: 100%; height: 130px;"></div>
        </div>
    </div>

    <div class="loading" id="loading">正在加载地图数据...</div>

    <!-- 加载配置文件 -->
    <script type="text/javascript" src="./config.js"></script>

    <!-- 引入 ECharts 图表库 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

    <!-- 动态加载高德地图 API -->
    <script type="text/javascript">
        // 从配置文件读取高德地图 API 配置
        const AMAP_KEY = window.AMAP_CONFIG.key;
        const SECURITY_CODE = window.AMAP_CONFIG.securityCode;

        // 设置安全密钥（需要在加载地图API之前设置）
        window._AMapSecurityConfig = {
            securityJsCode: SECURITY_CODE,
        };

        // 动态加载高德地图 JS API
        const mapScript = document.createElement('script');
        mapScript.type = 'text/javascript';
        mapScript.src = `https://webapi.amap.com/maps?v=2.0&key=${AMAP_KEY}&plugin=AMap.Scale,AMap.ToolBar,AMap.DistrictSearch`;
        document.head.appendChild(mapScript);

        // 动态加载 LOCA 数据可视化 API
        const locaScript = document.createElement('script');
        locaScript.type = 'text/javascript';
        locaScript.src = `https://webapi.amap.com/loca?v=2.0.0&key=${AMAP_KEY}`;
        document.head.appendChild(locaScript);
    </script>

    <script>

        // CSV 文件路径（相对路径）
        const CSV_FILE_PATH = './dataset/SuzhouGardenList.csv';

        /**
         * CSV 解析函数 - 处理包含引号和逗号的复杂 CSV
         */
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            // 移除 BOM 并分割表头
            const headers = lines[0].replace(/^\uFEFF/, '').split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue; // 跳过空行

                const values = [];
                let currentValue = '';
                let insideQuotes = false;

                // 逐字符解析，正确处理 CSV 中的引号和逗号
                for (let char of lines[i]) {
                    if (char === '"') {
                        insideQuotes = !insideQuotes;
                    } else if (char === ',' && !insideQuotes) {
                        values.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                values.push(currentValue.trim()); // 添加最后一个值

                // 确保有足够的列数
                if (values.length >= headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].replace(/^"|"$/g, '') : ''; // 移除首尾引号
                    });
                    data.push(row);
                }
            }

            return data;
        }

        /**
         * 根据CSV字段判断园林保护等级
         * @param {string} protectionLevel - 文保单位级别字段（全国/省级/市级/县级）
         * @param {string} worldHeritage - 世界遗产字段（TRUE/FALSE）
         *
         * 颜色方案说明（红色→黄色渐变）：
         * 世界遗产：深红色 - 最高级别
         * 全国重点：红橙色 - 国家级保护
         * 省级：金橙色 - 省级保护
         * 市级：金黄色 - 市级保护
         * 其他：浅灰色 - 一般园林
         */
        function getGardenLevel(protectionLevel, worldHeritage) {
            // 优先判断是否为世界遗产
            if (worldHeritage && (worldHeritage.toUpperCase() === 'TRUE' || worldHeritage === '是')) {
                return { level: 'world', color: '#DC2626' }; // 深红色
            }

            // 根据文保单位级别字段判断
            if (!protectionLevel) {
                return { level: 'other', color: '#D1D5DB' }; // 浅灰色
            }

            const levelStr = protectionLevel.trim();

            if (levelStr === '全国' || levelStr.includes('全国')) {
                return { level: 'national', color: '#EA580C' }; // 红橙色
            } else if (levelStr === '省级' || levelStr.includes('省级')) {
                return { level: 'provincial', color: '#F59E0B' }; // 金橙色
            } else if (levelStr === '市级' || levelStr.includes('市级')) {
                return { level: 'city', color: '#EAB308' }; // 金黄色
            } else if (levelStr === '县级' || levelStr.includes('县级')) {
                return { level: 'city', color: '#EAB308' }; // 金黄色，县级归类到市级
            } else {
                return { level: 'other', color: '#D1D5DB' }; // 浅灰色
            }
        }

        /**
         * 获取保护等级的文字描述
         */
        function getLevelText(level) {
            const levelMap = {
                'world': '世界文化遗产',
                'national': '全国重点文物保护单位',
                'provincial': '省级文物保护单位',
                'city': '市级文物保护单位',
                'other': '其他'
            };
            return levelMap[level] || '未知';
        }

        function getLevelIndex(level) {
            const levelOrder = {
                'world': 4,
                'national': 3,
                'provincial': 2,
                'city': 1,
                'other': 0
            };
            return levelOrder[level] || 0;
        }

        /**
         * 应用筛选条件（级别）
         */
        function applyFilters() {
            globalMarkers.forEach((marker, index) => {
                const garden = globalGardenData[index];
                let shouldShow = true;

                // 检查级别筛选
                if (currentLevelFilter) {
                    if (garden.level !== currentLevelFilter) {
                        shouldShow = false;
                    }
                }

                // 显示或隐藏marker
                if (shouldShow) {
                    marker.show();
                } else {
                    marker.hide();
                }
            });

            // 输出筛选信息
            if (currentLevelFilter) {
                console.log(`已过滤显示：${getLevelText(currentLevelFilter)}`);
            }
        }

        /**
         * 设置级别筛选
         */
        function setLevelFilter(level) {
            // 如果点击的是当前已选中的级别，则取消筛选
            if (currentLevelFilter === level) {
                currentLevelFilter = null;
                // 移除active类
                document.querySelectorAll('.legend-item').forEach(item => {
                    item.classList.remove('active');
                });
            } else {
                currentLevelFilter = level;
                // 更新图例项的active状态
                document.querySelectorAll('.legend-item').forEach(item => {
                    if (item.dataset.level === level) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
            applyFilters();
        }

        /**
         * 重置所有筛选
         */
        function resetFilters() {
            currentLevelFilter = null;

            // 移除所有图例项的active状态
            document.querySelectorAll('.legend-item').forEach(item => {
                item.classList.remove('active');
            });

            // 显示所有marker
            globalMarkers.forEach(marker => {
                marker.show();
            });

            console.log('已重置过滤，显示所有园林');
        }

        // 全局变量存储园林数据和地图对象
        let globalGardenData = [];
        let globalMap = null;
        let districtPolygons = [];
        let currentSelectedDistrict = null;
        let districtClicked = false;  // 标记是否点击了区县
        let globalMarkers = [];  // 存储所有marker
        let currentLevelFilter = null;  // 当前选中的保护级别

        /**
         * 统计某个区县内各级文物保护单位数量及综合指标
         */
        function calculateDistrictStats(districtName) {
            const stats = {
                world: 0,
                national: 0,
                provincial: 0,
                city: 0,
                other: 0,
                total: 0
            };

            let totalArea = 0;
            let openCount = 0;
            let hasOpenData = 0;

            const districtGardens = globalGardenData.filter(garden => garden.district === districtName);

            districtGardens.forEach(garden => {
                stats[garden.level]++;
                stats.total++;

                // 累计面积
                if (garden.value && !isNaN(garden.value)) {
                    totalArea += garden.value;
                }

                // 统计开放情况
                if (garden.openStatus) {
                    hasOpenData++;
                    if (garden.openStatus === '开放' || garden.openStatus.includes('开放')) {
                        openCount++;
                    }
                }
            });

            // 计算综合指标
            stats.avgArea = stats.total > 0 ? Math.round(totalArea / stats.total) : 0;
            stats.openRate = hasOpenData > 0 ? Math.round((openCount / hasOpenData) * 100) : 0;
            stats.highLevelRate = stats.total > 0 ? Math.round(((stats.world + stats.national) / stats.total) * 100) : 0;

            return stats;
        }

        // 全局雷达图实例
        let radarChartInstance = null;

        /**
         * 更新区县统计面板
         */
        function updateDistrictPanel(districtName, stats) {
            document.getElementById('districtPanel').style.display = 'block';
            document.getElementById('districtName').textContent = districtName;
            document.getElementById('worldCount').textContent = stats.world;
            document.getElementById('nationalCount').textContent = stats.national;
            document.getElementById('provincialCount').textContent = stats.provincial;
            document.getElementById('cityCount').textContent = stats.city;
            document.getElementById('otherCount').textContent = stats.other;
            document.getElementById('totalDistrictCount').textContent = stats.total;

            // 更新雷达图
            updateRadarChart(districtName, stats);
        }

        /**
         * 绘制/更新雷达图
         */
        function updateRadarChart(districtName, stats) {
            // 初始化或获取ECharts实例
            const chartDom = document.getElementById('radarChart');
            if (!radarChartInstance) {
                radarChartInstance = echarts.init(chartDom);
            }

            // 计算标准化的指标值（0-100范围）
            // 园林总数的标准化：假设最大值为30
            const totalNormalized = Math.min((stats.total / 30) * 100, 100);

            // 高等级占比标准化：30%为满分（超过30%按100算）
            const highLevelRate = Math.min((stats.highLevelRate / 40) * 100, 100);

            // 平均面积标准化：假设10000㎡为满分
            const avgAreaNormalized = Math.min((stats.avgArea / 10000) * 100, 100);

            // 开放率标准化：80%为满分（超过80%按100算）
            const openRate = Math.min(stats.openRate , 100);

            // 精品密度标准化：每10个园林中有3个精品为满分
            const premiumDensity = stats.total > 0 ?
                Math.min(((stats.world + stats.national) / stats.total / 0.3) * 100, 100) : 0;

            const option = {
                radar: {
                    indicator: [
                        { name: '园林总数', max: 100 },
                        { name: '高等级占比', max: 100 },
                        { name: '平均面积', max: 100 },
                        { name: '开放率', max: 100 },
                        { name: '精品密度', max: 100 }
                    ],
                    shape: 'polygon',
                    splitNumber: 3,
                    radius: '60%',
                    name: {
                        textStyle: {
                            color: '#666',
                            fontSize: 11
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#e0e0e0'
                        }
                    },
                    splitArea: {
                        areaStyle: {
                            color: ['rgba(250, 250, 250, 0.5)', 'rgba(240, 240, 240, 0.3)']
                        }
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#ccc'
                        }
                    }
                },
                series: [{
                    type: 'radar',
                    data: [{
                        value: [
                            totalNormalized,
                            highLevelRate,
                            avgAreaNormalized,
                            openRate,
                            premiumDensity
                        ],
                        name: districtName,
                        areaStyle: {
                            color: 'rgba(234, 88, 12, 0.2)'
                        },
                        lineStyle: {
                            color: '#EA580C',
                            width: 2
                        },
                        itemStyle: {
                            color: '#EA580C'
                        }
                    }],
                    label: {
                        show: false
                    }
                }],
                tooltip: {
                    trigger: 'item',
                    confine: true,  // 限制在容器内显示，防止被裁剪
                    formatter: function(params) {
                        return `<b>${districtName}</b><br/>
                                园林总数: ${stats.total} 个<br/>
                                高等级占比: ${stats.highLevelRate}%<br/>
                                平均面积: ${stats.avgArea} ㎡<br/>
                                开放率: ${stats.openRate}%<br/>
                                精品密度: ${((stats.world + stats.national) / stats.total * 10).toFixed(1)}/10`;
                    }
                }
            };

            radarChartInstance.setOption(option);
        }

        /**
         * 从本地GeoJSON文件加载苏州市区县边界
         */
        function loadDistrictBoundaries(map) {
            return new Promise((resolve, reject) => {
                console.log('开始从本地加载苏州市精确区县边界...');

                // 从本地加载精确的区县边界数据（DataV提供的精确边界）
                fetch('./suzhou_districts.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('无法加载GeoJSON文件');
                        }
                        return response.json();
                    })
                    .then(geojson => {
                        console.log('成功加载GeoJSON数据:', geojson);

                        const features = geojson.features || [];
                        console.log(`共加载 ${features.length} 个区县边界`);

                        let polygonCount = 0;
                        features.forEach(feature => {
                            const districtName = feature.properties.name;
                            const coordinates = feature.geometry.coordinates;

                            console.log(`处理区县: ${districtName}`);

                            if (coordinates && coordinates.length > 0) {
                                // MultiPolygon 格式: coordinates[0][0] 是外环坐标数组
                                // 将GeoJSON坐标转换为高德地图格式
                                const path = coordinates[0][0].map(coord => new AMap.LngLat(coord[0], coord[1]));

                                console.log(`  - 坐标点数量: ${path.length}`);

                                // 创建多边形
                                const polygon = new AMap.Polygon({
                                    path: path,
                                    strokeColor: '#1890ff',
                                    strokeWeight: 2,
                                    strokeOpacity: 0.6,
                                    fillColor: '#1890ff',
                                    fillOpacity: 0.1,
                                    cursor: 'pointer',
                                    bubble: true
                                });

                                // 存储区县信息
                                polygon.districtName = districtName;

                                // 鼠标悬停效果
                                polygon.on('mouseover', function () {
                                    if (currentSelectedDistrict !== this) {
                                        this.setOptions({
                                            fillOpacity: 0.25,
                                            strokeWeight: 3
                                        });
                                    }
                                });

                                polygon.on('mouseout', function () {
                                    if (currentSelectedDistrict !== this) {
                                        this.setOptions({
                                            fillOpacity: 0.1,
                                            strokeWeight: 2
                                        });
                                    }
                                });

                                // 点击事件
                                polygon.on('click', function (e) {
                                    console.log('点击区县:', this.districtName);

                                    // 设置标志，防止地图点击事件触发
                                    districtClicked = true;

                                    // 重置之前选中的区县
                                    if (currentSelectedDistrict) {
                                        currentSelectedDistrict.setOptions({
                                            fillColor: '#1890ff',
                                            fillOpacity: 0.1,
                                            strokeWeight: 2
                                        });
                                    }

                                    // 高亮当前区县
                                    this.setOptions({
                                        fillColor: '#52c41a',
                                        fillOpacity: 0.35,
                                        strokeWeight: 3
                                    });

                                    currentSelectedDistrict = this;

                                    // 计算统计数据（使用CSV中的区县字段）
                                    const stats = calculateDistrictStats(this.districtName);
                                    console.log(`${this.districtName} 统计数据:`, stats);
                                    updateDistrictPanel(this.districtName, stats);

                                    // 延迟重置标志，确保地图点击事件不会触发
                                    setTimeout(function() {
                                        districtClicked = false;
                                    }, 100);
                                });

                                polygon.setMap(map);
                                districtPolygons.push(polygon);
                                polygonCount++;
                                console.log(`成功添加区县多边形: ${districtName}`);
                            }
                        });

                        console.log(`共成功添加 ${polygonCount} 个区县多边形到地图`);
                        resolve(features);
                    })
                    .catch(error => {
                        console.error('加载区县边界失败:', error);
                        reject(error);
                    });
            });
        }

        /**
         * 初始化地图和可视化图层
         */
        function initMapWithData(gardenData) {
            // 过滤并准备 LOCA 数据
            const locaData = gardenData
                .filter(garden => garden['经度'] && garden['纬度'] && garden['经度'] !== '' && garden['纬度'] !== '')
                .map(garden => {
                    // 从CSV字段中读取保护等级和世界遗产信息
                    const level = getGardenLevel(garden['文保单位级别'], garden['世界遗产']);
                    const lng = parseFloat(garden['经度']);
                    const lat = parseFloat(garden['纬度']);

                    // 验证经纬度是否有效
                    if (isNaN(lng) || isNaN(lat)) return null;

                    return {
                        name: garden['名称'] || '未命名',
                        lnglat: [lng, lat],
                        value: parseInt(garden['面积（㎡）']) || 1000,
                        color: level.color,
                        level: level.level,
                        address: garden['地址'] || '未知地址',
                        year: garden['建造年代'] || '未知',
                        description: garden['描述'] ? (garden['描述'].length > 150 ? garden['描述'].substring(0, 150) + '...' : garden['描述']) : '暂无描述',
                        openStatus: garden['开放情况'] || '未知',
                        fullDescription: garden['描述'] || '暂无描述',
                        district: garden['区县'] || '未知区县',
                        protectionLevel: garden['文保单位级别'] || '',
                        worldHeritage: garden['世界遗产'] || ''
                    };
                })
                .filter(item => item !== null); // 移除无效数据

            // 存储到全局变量
            globalGardenData = locaData;

            // 更新统计信息
            document.getElementById('total-count').textContent = locaData.length;

            console.log('成功加载 ' + locaData.length + ' 个有效园林数据点');

            // 初始化地图
            const map = new AMap.Map('container', {
                zoom: 12,
                center: [120.62, 31.31], // 苏州市中心
                viewMode: '3D',
                pitch: 40,
                rotation: 0,
                mapStyle: 'amap://styles/blue',
                showLabel: true
            });

            // 存储到全局变量
            globalMap = map;

            // 添加地图控件
            map.addControl(new AMap.Scale());
            map.addControl(new AMap.ToolBar({
                position: {
                    bottom: '20px',
                    right: '20px'
                }
            }));

            // 初始化 Loca 容器
            const loca = new Loca.Container({
                map: map
            });

            // 添加脉冲图层（更美观的动画效果）- 可选，如果影响性能可以注释掉
            /*
            const pulseLayer = new Loca.PulseLinkLayer({
                loca: loca,
                zIndex: 5,
                opacity: 0.6,
                visible: true,
                zooms: [2, 22]
            });

            pulseLayer.setSource(dataSource);
            pulseLayer.setStyle({
                unit: 'meter',
                dash: [40000, 0, 40000, 0],
                lineWidth: () => [20000, 1000],
                height: () => [100, 10000],
                smoothSteps: 30,
                speed: () => 1 + Math.random() * 10000,
                flowLength: 100000,
                lineColors: (index, feature) => {
                    const color = feature.properties.color;
                    return [color, color];
                },
                maxHeightScale: 0.4,
                headColor: 'rgba(255, 255, 255, 0.8)',
                trailColor: 'rgba(255, 255, 255, 0.2)'
            });
            */

            // 计算标记点大小的函数（根据面积）
            function getMarkerSize(area) {
                // 面积范围：200 - 50000 ㎡
                // 点大小范围：8 - 32 px
                const minSize = 8;
                const maxSize = 32;
                const minArea = 200;
                const maxArea = 50000;

                // 使用对数缩放，使大小分布更均匀
                const normalizedArea = Math.max(minArea, Math.min(maxArea, area));
                const logMin = Math.log(minArea);
                const logMax = Math.log(maxArea);
                const logArea = Math.log(normalizedArea);

                const size = minSize + (logArea - logMin) / (logMax - logMin) * (maxSize - minSize);
                return Math.round(size);
            }

            // 在 LOCA 图层之上添加透明的 Marker 标记点用于事件处理
            const markers = [];
            let currentInfoWindow = null;
            let closeTimer = null; // 延迟关闭定时器

            locaData.forEach(item => {
                // 根据面积计算标记点大小
                const markerSize = getMarkerSize(item.value);
                const markerHalfSize = markerSize / 2;

                // 创建自定义 HTML 标记 - 大小根据面积动态调整
                const markerContent = document.createElement('div');
                markerContent.style.width = markerSize + 'px';
                markerContent.style.height = markerSize + 'px';
                markerContent.style.borderRadius = '50%';
                markerContent.style.background = item.color;
                markerContent.style.border = '2px solid rgba(255, 255, 255, 0.9)';
                markerContent.style.boxShadow = '0 0 8px rgba(0, 0, 0, 0.4)';
                markerContent.style.cursor = 'pointer';
                markerContent.style.transition = 'all 0.2s ease';

                // 添加悬停效果
                markerContent.onmouseenter = function () {
                    this.style.transform = 'scale(1.5)';
                    this.style.zIndex = '1000';
                };
                markerContent.onmouseleave = function () {
                    this.style.transform = 'scale(1)';
                };

                const marker = new AMap.Marker({
                    position: item.lnglat,
                    content: markerContent,
                    offset: new AMap.Pixel(-markerHalfSize, -markerHalfSize),
                    zIndex: 100 * getLevelIndex(item.level) // 根据保护等级调整 zIndex
                });

                // 鼠标悬停事件
                marker.on('mouseover', function (e) {
                    // 清除之前的关闭定时器
                    if (closeTimer) {
                        clearTimeout(closeTimer);
                        closeTimer = null;
                    }

                    // 关闭之前的信息窗口
                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                    }

                    currentInfoWindow = new AMap.InfoWindow({
                        isCustom: false,
                        content: `
                            <div class="detail-popup" id="info-popup-${item.name.replace(/[^a-zA-Z0-9]/g, '')}">
                                <h3>${item.name}</h3>
                                <p><span class="label">地址:</span> ${item.address}</p>
                                <p><span class="label">建造年代:</span> ${item.year}</p>
                                <p><span class="label">开放情况:</span> ${item.openStatus}</p>
                                <p style="max-height: 100px; overflow-y: auto;"><span class="label">简介:</span> ${item.description}</p>
                            </div>
                        `,
                        offset: new AMap.Pixel(0, -30),
                        autoMove: true
                    });
                    currentInfoWindow.open(map, item.lnglat);

                    // 给信息窗口内容添加鼠标事件监听（延迟以确保DOM已渲染）
                    setTimeout(() => {
                        const popup = currentInfoWindow.dom;
                        if (popup) {
                            popup.onmouseenter = function() {
                                // 鼠标进入信息窗口，取消关闭
                                if (closeTimer) {
                                    clearTimeout(closeTimer);
                                    closeTimer = null;
                                }
                            };
                            popup.onmouseleave = function() {
                                // 鼠标离开信息窗口，延迟关闭
                                closeTimer = setTimeout(() => {
                                    if (currentInfoWindow) {
                                        currentInfoWindow.close();
                                        currentInfoWindow = null;
                                    }
                                }, 500);
                            };
                        }
                    }, 100);
                });

                // 鼠标移出事件 - 延迟关闭弹窗
                marker.on('mouseout', function (e) {
                    // 延迟关闭，给用户时间移动鼠标到信息窗口上
                    closeTimer = setTimeout(() => {
                        if (currentInfoWindow) {
                            currentInfoWindow.close();
                            currentInfoWindow = null;
                        }
                    }, 300); // 300ms延迟
                });

                // 点击事件 - 显示完整详细信息
                marker.on('click', function (e) {
                    // 清除之前的关闭定时器
                    if (closeTimer) {
                        clearTimeout(closeTimer);
                        closeTimer = null;
                    }

                    // 设置标志，防止地图点击事件触发
                    districtClicked = true;

                    // 关闭之前的信息窗口
                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                    }

                    // 延迟重置标志
                    setTimeout(function() {
                        districtClicked = false;
                    }, 100);

                    currentInfoWindow = new AMap.InfoWindow({
                        isCustom: false,
                        content: `
                            <div class="detail-popup" style="max-width: 400px;">
                                <h3 style="color: #1890ff; font-size: 18px; margin-bottom: 12px;">${item.name}</h3>
                                <p><span class="label">地址:</span> ${item.address}</p>
                                <p><span class="label">建造年代:</span> ${item.year}</p>
                                <p><span class="label">面积:</span> ${item.value} ㎡</p>
                                <p><span class="label">开放情况:</span> ${item.openStatus}</p>
                                <p><span class="label">保护等级:</span> ${getLevelText(item.level)}</p>
                                <div style="max-height: 200px; overflow-y: auto; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                                    <p><span class="label">详细介绍:</span></p>
                                    <p style="line-height: 1.8; color: #666;">${item.fullDescription}</p>
                                </div>
                            </div>
                        `,
                        offset: new AMap.Pixel(0, -30),
                        autoMove: true
                    });
                    currentInfoWindow.open(map, item.lnglat);

                    // 给信息窗口内容添加鼠标事件监听（延迟以确保DOM已渲染）
                    setTimeout(() => {
                        const popup = currentInfoWindow.dom;
                        if (popup) {
                            popup.onmouseenter = function() {
                                // 鼠标进入信息窗口，取消关闭
                                if (closeTimer) {
                                    clearTimeout(closeTimer);
                                    closeTimer = null;
                                }
                            };
                            popup.onmouseleave = function() {
                                // 鼠标离开信息窗口，延迟关闭
                                closeTimer = setTimeout(() => {
                                    if (currentInfoWindow) {
                                        currentInfoWindow.close();
                                        currentInfoWindow = null;
                                    }
                                }, 300);
                            };
                        }
                    }, 100);
                });

                marker.setMap(map);
                markers.push(marker);
                globalMarkers.push(marker);  // 存储到全局数组用于过滤
            });

            // 点击地图空白处关闭信息窗口和重置区县选择
            map.on('click', function () {
                // 如果刚刚点击了区县，则忽略这次地图点击事件
                if (districtClicked) {
                    console.log('忽略地图点击事件（刚点击了区县）');
                    return;
                }

                console.log('点击地图空白处');

                if (currentInfoWindow) {
                    currentInfoWindow.close();
                }

                // 重置区县选择
                if (currentSelectedDistrict) {
                    currentSelectedDistrict.setOptions({
                        fillColor: '#1890ff',
                        fillOpacity: 0.1,
                        strokeWeight: 2
                    });
                    currentSelectedDistrict = null;
                }

                // 隐藏区县统计面板
                document.getElementById('districtPanel').style.display = 'none';

                // 重置所有筛选（年代和级别）
                resetFilters();
            });

            // 启动动画渲染
            loca.animate.start();

            console.log('地图可视化渲染完成！');

            // 加载区县边界
            document.getElementById('loading').textContent = '正在加载区县边界...';
            document.getElementById('loading').style.display = 'block';

            loadDistrictBoundaries(map)
                .then(() => {
                    console.log('区县边界加载完成！');
                    document.getElementById('loading').style.display = 'none';
                })
                .catch(error => {
                    console.error('加载区县边界失败:', error);
                    document.getElementById('loading').textContent = '区县边界加载失败，但园林数据仍可正常查看';
                    setTimeout(() => {
                        document.getElementById('loading').style.display = 'none';
                    }, 3000);
                }).finally(() => {
                    // 隐藏加载提示
                    setTimeout(() => {
                        document.getElementById('loading').style.display = 'none';
                    }, 2000);
                });
        }

        /**
         * 从本地 CSV 文件加载数据
         */
        async function loadCSVData() {
            try {
                document.getElementById('loading').textContent = '正在加载 CSV 数据...';

                const response = await fetch(CSV_FILE_PATH);
                if (!response.ok) {
                    throw new Error('CSV 文件加载失败: ' + response.statusText);
                }

                const csvText = await response.text();
                const gardenData = parseCSV(csvText);

                console.log('成功读取 CSV 文件，共 ' + gardenData.length + ' 条原始记录');

                if (gardenData.length === 0) {
                    throw new Error('CSV 文件中没有有效数据');
                }

                // 初始化地图
                initMapWithData(gardenData);

            } catch (error) {
                console.error('加载 CSV 文件时出错:', error);
                document.getElementById('loading').textContent = '加载数据失败: ' + error.message;
                document.getElementById('loading').style.color = '#ff4d4f';
                document.getElementById('loading').style.background = '#fff2f0';
                document.getElementById('loading').style.border = '1px solid #ffccc7';
            } finally {
                // 隐藏加载提示
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                }, 2000);
            }
        }

        // 页面加载完成后执行
        window.onload = function () {
            // 确保高德地图 API 加载完成
            if (typeof AMap !== 'undefined' && typeof Loca !== 'undefined') {
                loadCSVData();
            } else {
                console.error('高德地图 API 加载失败');
                document.getElementById('loading').textContent = '地图 API 加载失败，请检查网络连接';
                document.getElementById('loading').style.color = '#ff4d4f';
            }
        };

        // DOM加载完成后绑定事件
        document.addEventListener('DOMContentLoaded', function() {
            // 给图例项添加点击事件
            document.querySelectorAll('.legend-item').forEach(item => {
                item.addEventListener('click', function() {
                    const level = this.dataset.level;
                    setLevelFilter(level);
                });
            });
        });

        // 监听窗口大小变化，重绘图表
        window.addEventListener('resize', function() {
            if (radarChartInstance) {
                radarChartInstance.resize();
            }
        });
    </script>
</body>

</html>